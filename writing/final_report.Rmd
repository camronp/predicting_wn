---
title: "Final Project Report - Predicting West Nile Virus"
author: "Group 3 - Camron Pearce, Amy Fox, Alyssa Melvin, Kayla Williams"
date: "December 7, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load_libraries, echo = FALSE, message = FALSE}
library(readr)
library(dplyr)
library(lubridate)
library(stringr)
library(leaflet)
library(viridisLite)
library(tidyr)
library(rnoaa)
library(ggplot2)
library(knitr)
library(mfp)
library(corrplot)
library(broom)
library(modelr)
library(rpart)
library(randomForest)
library(rpart.plot)
library(scales)
library(gridExtra)
```


*Our GitHub is accessible [here](https://github.com/camronp/predicting_wn).*

# Aim

To build a predictive model that incorporates weather to provide early indications of the risk of WNV infection in Chicago, Illinois. 

# Datasets Used
	
We used mosquito trap data from Chicago, Illinois which we found in a Kaggle competition website. We had some issues trying to find usable data for Colorado or other regions in the US, so we settled with this particular dataset. This particular data set had information on the year and week the trap was set and collected, the test ID, the trap number, the block or location where the trap was set, the type of trap, the test date of the mosquito specimens, the number of mosquitoes tested, the result of the mosquitoes that were tested, the species identification of the mosquitoes, and the latitude and longitude of the trap locations. A majority of the traps set were Gravid traps which are designed to catch *Culex* species that are capable of transmitting the West Nile virus. We wanted to calculate the proportion of positive mosquitoes collected each week and a snapshot of the resulting final data set is below.

```{r mosquito_data_table, echo = FALSE, message = FALSE}
mosquito_data_original <- read_csv("https://data.cityofchicago.org/api/views/jqe8-8r6s/rows.csv?accessType=DOWNLOAD")

mosquito_data <- mosquito_data_original %>%
  filter(`SEASON YEAR` %in% c(2016, 2017, 2018)) %>%
  mutate(`TEST DATE` = mdy_hms(`TEST DATE`)) %>%
  rename_all(.funs = str_to_lower) %>%
  rename(year = `season year`, test_id = `test id`, test_date = `test date`,
         number_mosquitos = `number of mosquitoes`)

mosquito_data_tot <- mosquito_data %>%
  group_by(week, year) %>%
  summarise(total_no_mos = sum(number_mosquitos))

positive_mosquito <- mosquito_data %>%
  group_by(week, year) %>%
  filter(result == "positive") %>%
  summarise(pos_mos_no = sum(number_mosquitos))

final_mosquito <- mosquito_data_tot %>%
  full_join(positive_mosquito) %>%
  mutate_if(is.integer, funs(replace(., is.na(.), 0))) %>%
  mutate(prop_pos_mos = pos_mos_no / total_no_mos) %>%
  select(week, year, pos_mos_no, total_no_mos, prop_pos_mos)

final_mosquito_pretty <-  final_mosquito %>%
  rename("# of WNV mosquitoes"= pos_mos_no,
         "total # of mosquitoes" = total_no_mos,
         "% mosquitoes with WNV" = prop_pos_mos)

kable(head(final_mosquito_pretty), align = "l")
```


When we were researching things that may influence WNV infection of mosquitos, we found a paper that explained soil temperature, precipitation, wind speed, and relative humidity have some sort of association with WNV infected mosquitos in Northern Greece. With that in mind, we chose Chicago, Illinois NOAA weather data with the parameters described in the paper. We had quite a few columns which had mostly NAs so we wanted to filter it down to just precipitation for this particular project. We grouped the data by year and week and found the mean precipitation for that week and year. 


```{r weather_data, echo = FALSE, message = FALSE, warning = FALSE}
weather_data <- 
  read_csv("../data/weather_data.csv") %>% 
  rename(station = "STATION",
         name = "NAME",
         date = "DATE") %>% 
  mutate(week = week(date)) %>% 
  mutate(year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11) %>% 
  group_by(year, week) %>% 
  mutate(TMAX_avg = mean(TMAX, na.rm = TRUE)) %>% 
  mutate(TMIN_avg = mean(TMIN, na.rm = TRUE)) %>% 
  mutate(avg_temp = (TMIN_avg + TMAX_avg)/2) %>% 
  mutate(WDMV = as.numeric(WDMV)) %>% 
  mutate(WDMV = max(WDMV, na.rm = TRUE )) %>% 
  select(-TOBS, -date, -SN32, -SN52, -SX32, -SX52, -station, -name,
         -TMAX, -TMIN) %>% 
  arrange(year, week) %>%
  filter(row_number() == 1) %>% 
  ungroup()

precip_data <- read_csv("../data/precip.csv") %>% 
  select(PRCP, DATE) %>% 
  mutate(week = week(DATE)) %>% 
  mutate(year = year(DATE)) %>%
  filter(month(DATE) > 4 & month(DATE) < 11) %>% 
  select(year, week, PRCP) %>%
  group_by(year, week) %>% 
  summarise(precip_mean = mean(PRCP, na.rm = TRUE)) %>%
  arrange(year, week) %>% 
  ungroup()

precip_data_pretty <- precip_data %>%
  rename("avg precipitation (inch)" = precip_mean)

kable(head(precip_data_pretty), align = "l")
```

We wanted to find soil temperature data as well. We found soil data in an area that was near Illinois, but about 20 miles away. When we spoke with professionals in the field, we were told it would be beneficial to filter our data to average soil temperature in 4 inch sod and average soil temperature in 2 inch bare soil. We also grouped this data by week and year and found the average for those weeks. 

```{r soil_temp_data, echo = FALSE, message = FALSE, warning = FALSE}
soil_2017 <- read.delim("https://www.isws.illinois.edu/warm/data/cdfs/stcday.txt") %>% 
  filter(year %in% c(2016, 2017)) %>%
  select(year, month, day,
         avg_soiltemp_4in_sod, avg_soiltemp_2in_bare) %>% 
  unite(date, month, day, year, sep = "-") %>% 
  mutate(date = mdy(date)) %>% 
  mutate(week = week(date)) %>% 
  mutate(year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11) %>%
  na.omit()

soil_2018 <- 
  read.delim("https://www.isws.illinois.edu/warm/data/cdfs/current/stcday18.txt") %>% 
  select(year, month, day,
         avg_soiltemp_4in_sod, avg_soiltemp_2in_bare) %>% 
  unite(date, month, day, year, sep = "-") %>% 
  mutate(date = mdy(date)) %>% 
  slice(-1) %>% 
  mutate(week = week(date)) %>% 
  mutate(year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11) %>%
  na.omit()

all_soil_temps <-
  rbind(soil_2017, soil_2018) %>% 
  mutate(avg_soiltemp_4in_sod = as.numeric(as.character(avg_soiltemp_4in_sod))) %>%
  mutate(avg_soiltemp_2in_bare = as.numeric(as.character(avg_soiltemp_2in_bare))) %>%
  group_by(year, week) %>% 
  summarise(avg_soil_t_4 = mean(avg_soiltemp_4in_sod, 
                                na.rm = TRUE),
            avg_soil_t_2 = mean(avg_soiltemp_2in_bare, 
                                na.rm = TRUE))

all_soil_temps_pretty <- all_soil_temps %>%
    rename("avg 4 inch soil temp (°F)" = avg_soil_t_4,
         "avg 2 inch soil temp (°F)" = avg_soil_t_2)

kable(head(all_soil_temps_pretty), align = "l")
```

```{r storm_data, echo = FALSE, message = FALSE, warning = FALSE}
storms_2016 <- read_csv("../data/StormEvents_details-ftp_v1.0_d2016_c20180718.csv") 

storms_2017 <- read_csv("../data/StormEvents_details-ftp_v1.0_d2017_c20181017.csv")

storms_2018 <- read_csv("../data/StormEvents_details-ftp_v1.0_d2018_c20181017.csv")

all_storm <- rbind(storms_2016, storms_2017, storms_2018) %>%
  rename_all(.funs = str_to_lower) %>%
  filter(state == "ILLINOIS" & cz_name == "COOK") %>%
  mutate(date = begin_date_time) %>%
  select(date, event_type, begin_lat, begin_lon, end_lat, end_lon) %>%
  mutate(date = dmy_hms(date)) %>%
  mutate(week = week(date), 
         year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11)
storm_events <- unique(all_storm[c("year", "week", "event_type")])

```


```{r joining_all_data, echo = FALSE, message = FALSE, warning = FALSE}
all_data <- left_join(final_mosquito, storm_events, by = c("year", "week")) %>%
            left_join(all_soil_temps, by =  c("year", "week")) %>%
            left_join(weather_data, by =  c("year", "week")) %>% 
            left_join(precip_data, by =  c("year", "week"))

```

# How we tackled the problem

First we had to find the data we wanted to use from various sources. We then had to clean the data and modify it to a point where we could use it for what we had planned to do. We then wanted to examine the relationships among the variables.   

```{r preliminary visualization, echo = FALSE, message = FALSE, fig.cap = "Relationships among Mean Temperature and Mosquito Count, Mean Temperature and Proportion of Positive Mosquitoes, Mean Precipitation and Mosquito Count, and Mean Soil Temperature and Mosquito count"}


#average temp by mosquito count
temp_count <- ggplot(all_data, aes(x = avg_temp, 
                     y = total_no_mos, color = pos_mos_no)) +
  geom_point() +
  scale_color_gradient(low = "blue", high = "red", labels = comma) +
  scale_y_continuous(labels = comma) +
  geom_smooth(se = FALSE, color = "black") +
  labs(x = "Mean Temperature (°F)", y = "Mosquito Count",
       color = "# Mosquitoes \nPositive for WNV") 

#average temp by proportion
temp_prop <- ggplot(all_data, aes(x = avg_temp, 
                     y = prop_pos_mos, color = pos_mos_no)) +
  geom_point() +
  scale_color_gradient(low = "blue", high = "red", labels = comma) +
  scale_y_continuous(labels = comma) +
  geom_smooth(se = FALSE, color = "black") +
  labs(x = "Mean Temperature (°F)", y = "Proportion of \nPositive Mosquitoes",
       color = "# Mosquitoes \nPositive for WNV") 

grid.arrange(temp_count, temp_prop, nrow = 2)


#avg soil temp 4 inch
soil_4 <- ggplot(all_data, aes(x = avg_soil_t_4, 
                     y = total_no_mos, color = pos_mos_no)) +
  geom_point() +
  scale_color_gradient(low = "blue", high = "red", labels = comma) +
  scale_y_continuous(labels = comma) +
  geom_smooth(se = FALSE, color = "black") +
  labs(x = "Mean Soil Temperature, 4 inch (°F)", y = "Mosquito Count",
         color = "# Mosquitoes \nPositive for WNV")

# precip mean
precip_plot <- ggplot(all_data, aes(x = precip_mean, 
                     y = total_no_mos, color = pos_mos_no)) +
  geom_point() +
  scale_color_gradient(low = "blue", high = "red", labels = comma) +
  scale_y_continuous(labels = comma) +
  geom_smooth(se = FALSE, color = "black") +
  labs(x = "Mean Precipitation (inches)", y = "Mosquito Count",
       color = "# Mosquitoes \nPositive for WNV")

grid.arrange(precip_plot, soil_4, nrow = 2)

```

Our correlation plot indicates that there is a positive association between the number of positive WNV mosquitoes and average soil temperature in 4 inch sod, average soil temperature in 2 inch bare soil, average temperature, and mean precipitation.

```{r correlation_plot, echo = FALSE, fig.width = 6, fig.height = 6, fig.cap = "Correlation Plot for WNV Project"}

# Remove columns with character values and malke pretty label names
data_wo_char <- all_data %>%
  select(-event_type, -year, -TMIN_avg, -TMAX_avg, -WDMV) %>%
  rename("# of WNV mosquitoes"= pos_mos_no,
         "total # of mosquitoes" = total_no_mos,
         "ratio of WNV mosquitoes" = prop_pos_mos,
         "average 4 inch soil temp" = avg_soil_t_4,
         "average 2 inch soil temp" = avg_soil_t_2,
         "average temp" = avg_temp,
         "average precipitation" = precip_mean)

correlation <- cor(data_wo_char)

corrplot(correlation, method = "number", "upper", 
         title = "Variable Correlation Plot",
         mar=c(0,0,2,0))
```

We wanted to use the proportion of positive mosquitoes collected in our prediction model rather than count of positive mosquitoes to remove some of the collection bias in the 2016 data where there was increased funding to evaluate WNV mosquitoes.

To build a prediction model for proportion of positive mosquitos, we tested three type of models: a linear prediction model, a regression tree, and random forest. For the models, we split the data into 2 sections: the first would contains the data collected from 2016 and 2017 to train the datasets, and the second contains the 2018 data to test the accuracy of the models.


```{r splitting_data, echo = FALSE, message = FALSE, warning = FALSE}
train_all_data <- all_data %>%
  filter(year %in% c(2016, 2017))

test_all_data <- all_data %>%
  filter(year == 2018)
```

We wanted to use the proportion of positive mosquitoes collected in our prediction model rather than count of positive mosquitoes to remove some of the collection bias in the 2016 data where there was increased funding to evaluate WNV mosquitoes.

To build a prediction model for proportion of positive mosquitos, we tested three type of models: a linear prediction model, a regression tree, and random forest. For the models, we split the data into 2 sections: the first would contains the data collected from 2016 and 2017 to train the datasets, and the second contains the 2018 data to test the accuracy of the models.

For the linear prediction model we looked at Nick Good's example he used in class for his running data and attempted something similar. When we tested the prediction model for week 34 in 2017:  72.1 t4, 74.7 t2, 0.078 precip - the actual proportion should be 0.52. The proportion our model output is below. 

```{r prediction_model, echo = FALSE, message = FALSE, warning = FALSE}
# input the variables we believe to be predictive
equation_test <- formula(prop_pos_mos ~ fp(week) +fp(avg_temp) + fp(precip_mean) + fp(avg_soil_t_4) + fp(avg_soil_t_2) )

# multivariate fractional polynomials will determine to what power each variable should be multiplied
mfp_testing <- mfp(equation_test, data = train_all_data, select = 0.05)

# perform linear model with the formula developed from the mfp_testing
linear_fit <- lm(mfp_testing$formula, train_all_data)

```
The mean average error for the proportion of positive mosquitoes for the linear model was also calculated to be `r mae(model = linear_fit, data = test_all_data)`.  

Decision tree learning looks at multiple observations to predict a conclusion based off of yes/no decisions about the data.  
```{r regression_tree, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Decision tree plot for WNV observations"}
tree_fit <- rpart(prop_pos_mos ~ precip_mean + avg_soil_t_4 + avg_soil_t_2 + week + avg_temp,
  	method="class", data = train_all_data)

# plot decision tree 
prp(tree_fit, main="Classification Tree for Predicting Proportion of Positive Mosquitoes",
    fallen.leaves = TRUE, varlen = 11, digits = 2)	
```
For the regression tree model, the mean average error for the proportion of positive mosquitoes is be `r mae(model = tree_fit, data = test_all_data)`.  

Random Forest is similar to decision trees, but it is more robust in that it creates many trees (in the case of our model, 500) and uses the mean prediction of all of the trees to predict an outcome. 
```{r random_forest, echo = FALSE, message = FALSE, warning = FALSE}

# build random forest prediction model
forest_fit <- randomForest(prop_pos_mos ~ precip_mean + avg_soil_t_4 + avg_soil_t_2 + week + avg_temp,
  	data = train_all_data, importance = TRUE)

```
The random forest model, the mean average error for the proportion of positive mosquitoes is be `r mae(model = forest_fit, data = test_all_data)`.

In the future it would have been interesting to add in our random forest prediction model to our shiny app where the user could input the temperature, precipitation, week, etc. and it would calculate both the expected total number of mosquitoes to be caught that week and the proportion of positive mosquitoes.

# Discovery of Interesting Things	

There was a large number of positive WNV tested mosquitos the 30th week of 2016. The dates for this time were July 25th through July 31st. The precipitation mean during that time was 0.467 inches. There is a negative association between the average soil temperatures (in both 2 inch bare soil and in 4 inch sod) and precipitation.  In 2016 there was an increase of funding for mosquito collection and a narrow weekly temperature range which could account for these differences. 

WNV incidence goes up if the daily high temperature in the spring and early summer is warmer than 81 degrees more often than normal (ScienceNetLinks, 2018). This is because *Culex pipiens* will peak earlier and thus more WNV cases. In 2016, the average max temperature was ~82 degrees F in week 22 and continued to be near the 80's until week 39. There were 14 weeks in 2016 where the average high temperature was above 81 whereas there were only 10 and 11 weeks in 2017 and 2018, respectively, where the average high temperature was above 81.  

For the prediction models it was also interesting that each of the models chose different variables that they deemed important in predicting the proportion of positive mosquitoes. The multivariate fractional polynomail and linear model used week and average temperature while the regression tree used week and average precipitation. Finally, random forest used all of the variables to a different degree to predict the proportion of positive mosquitoes.  

The Kaggle competition data for predicting WNV in Chicago, Illinois included the same mosquito trap data that we used, but also included insecticide spray data and weather data that included data like precipitation, wind, and temperature which we used in our model as well as dew point, sunrise and sunset, and air pressure. Comparing our prediction model to the Kaggle competition online in 2015, is somewhat difficult. A different evaluation method from mean average error  was used (receiver operating characteristic [ROC]). It appears as though the highest ROC for the competition was 0.8599, however, we had difficulty trying to calculate the ROC for our data.

When comparing different variable by year, it became clear that in 2016 there was significantly more mosquito data collected. There are roughly twice as many data points by week when compared to both 2017 and 2018. One conjecture is that there may have been an increase in the overall mosquito population due to the atypical moderate temperatures. On average, the spread minimum and maximum temperature was smaller than the subsequent years. A completely different (unpaired) conjecture is that there was an increase in available funding for 2016 mosquito research. At this time, Illinois was coming out of one of the worst mosquito years (2015), which may have raised an interest and awareness towards mosquitoes as hosts of vector borne illness.


# How project fits into West Nile research

West Nile virus is mostly spread to people by mosquito bites. Mosquito season in North America starts in the summer and continues through fall. There are no vaccines to prevent or medications to treat West Nile Virus (WNV) and cases have been reported in all of the US. Most people infected with WNV do not have symptoms, but about 1 in 5 people who are infected will develop a fever and other symptoms (CDC, 2018). Approximately 1 in 150 infected people will develop a serious illness (CDC, 2018). Since WNV is a virus of public health importance, it’s important to understand its current and future risk factors. Understanding the risk of WNV infection in the mosquito population will help us understand the risk of WNV infection in humans and what prevention methods will need to be communicated during most severe WNV infection times. 
Mosquito based surveillance has been a practical and popular way to estimate the risk of transmission of WNV to people. Temperature and precipitation play a role in driving mosquito infection rates and transmission of WNV. Weather conditions and patterns of meteorological events have important consequences for WNV transmission as well. High temperatures and low precipitation can often increase WNV mosquito infection.

# Challenges

As mentioned earlier, we did have issues finding usable data. We found quite a bit of information but unfortunately not in files we could use in R. The Center for Disease Control and Prevention (CDC) has a lot of information but it is mostly static maps we couldn’t find base data for. Vector Disease Control International also had quite a bit of information, but again unfortunately no hard data files. For this reason, and time restraints, is why we settled with Chicago mosquito trap data we found on the Kaggle competition website. 
We also had a hard time conceptualizing exactly what we wanted to predict. We started going down a hole of collecting a bunch of data and had to quickly realize we needed to pull back a bit. We had a lot of really great ideas and needed to decide what would be feasible in the small amount of time we had. We talked about how this particular project is sometimes an entire thesis for some students and we only had a few weeks to complete it. 

# What we’d do differently

* Contact Public Health Departments or other entities at the beginning for access to data
* Really understand prediction models in R
* Come up with an idea for a prediction model earlier
* Create a "records" document to track changes
* Changes and additions to the Shiny app such as adding prediction modeling
* Use sepearate "testing" notation for markdown chunks
* Annotate code more often
* Overall better communication

	
### References:

Centers for Disease Control and Prevention (CDC). West Nile virus. November 28, 2018. Retrieved from: https://www.cdc.gov/westnile/index.html

ScienceNetLInks. West Nile Weather. December 10, 2018. Retrieved from: http://sciencenetlinks.com/science-news/science-updates/west-nile-weather/
