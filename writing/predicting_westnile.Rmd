---
title: "predicting_westnile"
author: "Camron Pearce, Amy Fox, Alyssa Melvin, Kayla Williams"
date: "November 7, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
library(readr)
library(dplyr)
library(lubridate)
library(stringr)
library(leaflet)
library(viridisLite)
library(tidyr)
library(rnoaa)
library(corrplot)
library(mfp)
library(ggplot2)

```

Read in positive mosquito data and clean
Calculate proportion of positive mosquitoes
```{r}
mosquito_data_original <- read_csv("https://data.cityofchicago.org/api/views/jqe8-8r6s/rows.csv?accessType=DOWNLOAD") 

# clean column names
mosquito_data <- mosquito_data_original %>%
  filter(`SEASON YEAR` %in% c(2016, 2017, 2018)) %>%
  mutate(`TEST DATE` = mdy_hms(`TEST DATE`)) %>%
  rename_all(.funs = str_to_lower) %>%
  rename(year = `season year`, test_id = `test id`, test_date = `test date`,

         number_mosquitos = `number of mosquitoes`)

# find the total # mosquitoes collected each week
mosquito_data_tot <- mosquito_data %>%
  group_by(week, year) %>%
  summarise(total_no_mos = sum(number_mosquitos))


# find the sum of the # of positive mosquitoes collected each week
positive_mosquito <- mosquito_data %>%
  group_by(week, year) %>%
  filter(result == "positive") %>%
  summarise(pos_mos_no = sum(number_mosquitos))

# join the positive mosquitoes and total # of mosquitoes and calculate the proportion of positive mosquitoes collected each week 
final_mosquito <- mosquito_data_tot %>%
  full_join(positive_mosquito) %>%
  mutate_if(is.integer, funs(replace(., is.na(.), 0))) %>%
  mutate(prop_pos_mos = pos_mos_no / total_no_mos) %>%
  select(week, year, pos_mos_no, total_no_mos, prop_pos_mos) 

head(final_mosquito)

  
```

Read in and clean storm data
```{r storm data}
storms_2016 <- read_csv("../data/StormEvents_details-ftp_v1.0_d2016_c20180718.csv") 

storms_2017 <- read_csv("../data/StormEvents_details-ftp_v1.0_d2017_c20181017.csv")

storms_2018 <- read_csv("../data/StormEvents_details-ftp_v1.0_d2018_c20181017.csv")

all_storm <- rbind(storms_2016, storms_2017, storms_2018) %>%
  rename_all(.funs = str_to_lower) %>%
  filter(state == "ILLINOIS" & cz_name == "COOK") %>%
  mutate(date = begin_date_time) %>%
  select(date, event_type, begin_lat, begin_lon, end_lat, end_lon) %>%
  mutate(date = dmy_hms(date)) %>%
  mutate(week = week(date), 
         year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11)

head(all_storm)


#Remove double events 
storm_events <- unique(all_storm[c("year", "week", "event_type")])
  
```

Add interactive feature with number of positive or negative mosquitos found
Can use to see the locations where more positive mosquitoes are found
```{r}

pal <- colorFactor(viridis(2), final_mosquito$result)

# find the total # mosquitoes collected each week
mosquito_data_tot_leaf <- mosquito_data %>%
  group_by(latitude, longitude) %>%
  summarise(total_no_mos = sum(number_mosquitos))


# find the sum of the # of positive mosquitoes collected each week
positive_mosquito_leaf <- mosquito_data %>%
  group_by(latitude, longitude) %>%
  filter(result == "positive") %>%
  summarise(pos_mos_no = sum(number_mosquitos))

# join the positive mosquitoes and total # of mosquitoes and calculate the proportion of positive mosquitoes collected each week 
final_mosquito_leaf <- mosquito_data_tot_leaf %>%
  full_join(positive_mosquito_leaf) %>%
  mutate_if(is.integer, funs(replace(., is.na(.), 0))) %>%
  mutate(prop_pos_mos = pos_mos_no / total_no_mos) %>%
  select(latitude, longitude, pos_mos_no, total_no_mos, prop_pos_mos)
>>>>>>> 6e690765bb2a37eeb7cea7d64520398fa1438b84

pal <- colorFactor(viridis(10), final_mosquito_leaf$prop_pos_mos)

popup_info <- paste0("<b>Proportion positive mosquitoes<b>", final_mosquito_leaf$prop_pos_mos)

leaflet() %>%
  addTiles() %>%
  addCircleMarkers(data = final_mosquito_leaf, radius = ~final_mosquito_leaf$prop_pos_mos*10,
                   lng = ~longitude, lat = ~latitude, 
                   color = pal(final_mosquito_leaf$prop_pos_mos), opacity = 0.9,
                   group = "mosquito", popup = popup_info)  %>%
  addLegend(pal = pal, values = round(final_mosquito_leaf$prop_pos_mos, digits = 3), opacity = 0.9) 

#size of circle- total #
#proportion of positive  mosquitoes viridis color
# 
  
```

Try to redo leaflet
```{r}


pal <- colorFactor(viridis(2), final_mosquito$prop_pos_mos)

popup_info <- paste0("<b>Time<b>", mosquito_data$week,
                     "<b>Case<b>", mosquito_data$prop_pos_mos)

leaflet() %>%
  addTiles() %>%
  addCircleMarkers(data = final_mosquito, radius = 2, lng = ~longitude, lat = ~latitude, 
                   color = pal(mosquito_data$result), opacity = 0.9, group = "mosquito", popup = popup_info) %>% 
  addCircleMarkers(data = mosquito_data, radius = 2, lng = ~longitude, lat = ~latitude, 
                   color = pal(positive_mosquito$result), opacity = 0.9, group = "positive mosquito") %>%
  addLegend(pal = pal, values = mosquito_data$result, opacity = 0.9) %>%
  addLayersControl(baseGroups = c("base map"),
                   overlayGroups = c("mosquito", "positive mosquito"))
```

Read in soil data and clean up
```{r, st. charles soil data}
soil_2017 <- read.delim("https://www.isws.illinois.edu/warm/data/cdfs/stcday.txt") %>% 
  filter(year %in% c(2016, 2017)) %>%
  select(year, month, day,
         avg_soiltemp_4in_sod, avg_soiltemp_2in_bare) %>% 
  unite(date, month, day, year, sep = "-") %>% 
  mutate(date = mdy(date)) %>% 
  mutate(week = week(date)) %>% 
  mutate(year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11) %>%
  na.omit()

soil_2018 <- 
  read.delim("https://www.isws.illinois.edu/warm/data/cdfs/current/stcday18.txt") %>% 
  select(year, month, day,
         avg_soiltemp_4in_sod, avg_soiltemp_2in_bare) %>% 
  unite(date, month, day, year, sep = "-") %>% 
  mutate(date = mdy(date)) %>% 
  slice(-1) %>% 
  mutate(week = week(date)) %>% 
  mutate(year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11) %>%
  na.omit()

all_soil_temps <-
  rbind(soil_2017, soil_2018) %>% 
  mutate(avg_soiltemp_4in_sod = as.numeric(as.character(avg_soiltemp_4in_sod))) %>%
  mutate(avg_soiltemp_2in_bare = as.numeric(as.character(avg_soiltemp_2in_bare))) %>%
  group_by(year, week) %>% 
  summarise(avg_soil_t_4 = mean(avg_soiltemp_4in_sod, 
                                na.rm = TRUE),
            avg_soil_t_2 = mean(avg_soiltemp_2in_bare, 
                                na.rm = TRUE))

head(all_soil_temps)

tail(all_soil_temps)

```


Read in weather data and clean up
```{r weather}

weather_data <- read_csv("../data/weather_data.csv") %>% 
  rename(station = "STATION",
         name = "NAME",
         date = "DATE") %>% 
  mutate(week = week(date)) %>% 
  mutate(year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11) %>% 
  group_by(year, week) %>% 
  mutate(TMAX_avg = mean(TMAX, na.rm = TRUE)) %>% 
  mutate(TMIN_avg = mean(TMIN, na.rm = TRUE)) %>% 
  mutate(avg_temp = (TMIN_avg + TMAX_avg)/2) %>% 
  select(-TOBS, -date, -SN32, -SN52, -SX32, -SX52, -station, -name,
         -TMAX, -TMIN) %>% 
  arrange(year, week) %>% 
  ungroup()

weather_data[, c("week", "year", "TMIN_avg", "TMAX_avg", "avg_temp", "WDMV")]
  
head(weather_data)

```


Join all of the datasets together
```{r}

all_data <- left_join(final_mosquito, storm_events)
all_data <- left_join(all_data, all_soil_temps)
all_data <- left_join(all_data, weather_data)

head(all_data)

```

Plot positive mosquito and precipitation

Compare the preciptation by week and positive mosquitos by week on top of each other to see similarities-- acutally try to add on top of graph
 
```{r}

pos_2016 <- full_join(positive_mosquito, all_data) %>%
  filter(year == 2016)

library(ggplot2)

# 2D hexbin plots

ggplot(pos_2016, aes(x = week, y = precip_mean)) +
  geom_point() +
  geom_smooth() +
  labs(x = "Week of 2016", y = "Precipitation in inches??")
  ggtitle("Precipitation by Week in 2016")

new_mos<- mosquito_data %>%
  group_by(week, year, result) %>%
  summarise(no_mos = sum(number_mosquitos))

pos_plus_all <- full_join(new_mos, all_data) %>%
  filter(year == 2016)

ggplot(pos_plus_all, aes(x = week, y = no_mos, fill = result)) +
  geom_bar(stat = "identity") +
  labs(x = "Week of 2016", y = "Number of collected mosquitoes") +
  ggtitle("Positive West Nile Virus Mosquitoes 2016")

ggplot(pos_plus_all, aes(x = no_mos, y = precip_mean)) +
  geom_point() +
  geom_smooth() +
  labs(x = "number collected mosquitos", y = "average precipitation") +
  ggtitle("Not looking great on correlation")


```


Build prediction model for proportion of positive mosquitos
```{r}

equation_test <- formula(prop_pos_mos ~ fp(precip_mean) + fp(avg_soil_t_4) + fp(avg_soil_t_2) + fp(week))

mfp_testing <- mfp(equation_test, data = all_data, select = 0.05)

summary(mfp_testing)

mos_mod <- lm(mfp_testing$formula, all_data)

summary(mos_mod)

# test prediction model
predict.lm(mos_mod, data_frame(precip_mean = 0.078, avg_soil_t_4 = 72.1, avg_soil_t_2 = 74.7, week = 34))

#week 34 2017:  72.1 t4, 74.7 t2, 0.078 precip --> actual propotion = 0.52, 
```

Correlation matrix using correlogram 
Looks at different types of correlograms to visualize data

```{r}

# Remove columns with character values
data_wo_char <- all_data %>%
  select(-event_type, -year)

correlation <- cor(data_wo_char)

corrplot::corrplot(correlation, method = "number")

corrplot.mixed(correlation)

corrplot(correlation, method = "number", "upper")

pairs(data_wo_char)

cor(data_wo_char)

```


```{r}
library(corrr)

data_wo_char %>% 
    correlate() %>% 
  network_plot(min_cor = .2)

findCorrelation(all_data, cutoff = .75)


data_wo_char %>% 
  correlate() %>% 
  rearrange() %>% 
  shave() %>% 
  fashion()
```

```{r}

#want to find R^2 to see if there is any correlation between positive mosquitos and 
#different weather variables individually

#average temp
ggplot(all_data, aes(x = avg_temp, y = total_no_mos, color = pos_mos_no)) +
  geom_point()

#min temp
ggplot(all_data, aes(x = TMIN_avg, y = total_no_mos, color = pos_mos_no)) +
  geom_point()

#max temp
ggplot(all_data, aes(x = TMAX_avg, y = total_no_mos, color = pos_mos_no)) +
  geom_point()

#wind speed
ggplot(all_data, aes(x = WDMV, y = total_no_mos, color = pos_mos_no)) +
  geom_point()
  
  

```


