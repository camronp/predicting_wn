---
title: "Predicting Westnile"
author: "Camron Pearce, Amy Fox, Alyssa Melvin, Kayla Williams"
date: "November 7, 2018"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r, message = FALSE, warning = FALSE, echo = FALSE}
library(readr)
library(dplyr)
library(lubridate)
library(stringr)
library(leaflet)
library(viridisLite)
library(tidyr)
library(rnoaa)
library(corrplot)
library(mfp)
library(ggplot2)
library(modelr)
library(rpart)
library(randomForest)
library(rattle)
library(rpart.plot)

```

Read in positive mosquito data and clean
Calculate proportion of positive mosquitoes
```{r}
mosquito_data_original <- read_csv("https://data.cityofchicago.org/api/views/jqe8-8r6s/rows.csv?accessType=DOWNLOAD") 

# clean column names
mosquito_data <- mosquito_data_original %>%
  filter(`SEASON YEAR` %in% c(2016, 2017, 2018)) %>%
  mutate(`TEST DATE` = mdy_hms(`TEST DATE`)) %>%
  rename_all(.funs = str_to_lower) %>%
  rename(year = `season year`, test_id = `test id`, test_date = `test date`,
         number_mosquitos = `number of mosquitoes`)

# find the total # mosquitoes collected each week
mosquito_data_tot <- mosquito_data %>%
  group_by(week, year) %>%
  summarise(total_no_mos = sum(number_mosquitos))


# find the sum of the # of positive mosquitoes collected each week
positive_mosquito <- mosquito_data %>%
  group_by(week, year) %>%
  filter(result == "positive") %>%
  summarise(pos_mos_no = sum(number_mosquitos))

# join the positive mosquitoes and total # of mosquitoes and calculate the proportion of positive mosquitoes collected each week 
final_mosquito <- mosquito_data_tot %>%
  full_join(positive_mosquito) %>%
  mutate_if(is.integer, funs(replace(., is.na(.), 0))) %>%
  mutate(prop_pos_mos = pos_mos_no / total_no_mos) %>%
  select(week, year, pos_mos_no, total_no_mos, prop_pos_mos) 

head(final_mosquito)

  
```

Read in and clean storm data
```{r storm data, message = FALSE}
storms_2016 <- read_csv("../data/StormEvents_details-ftp_v1.0_d2016_c20180718.csv") 

storms_2017 <- read_csv("../data/StormEvents_details-ftp_v1.0_d2017_c20181017.csv")

storms_2018 <- read_csv("../data/StormEvents_details-ftp_v1.0_d2018_c20181017.csv")

all_storm <- rbind(storms_2016, storms_2017, storms_2018) %>%
  rename_all(.funs = str_to_lower) %>%
  filter(state == "ILLINOIS" & cz_name == "COOK") %>%
  mutate(date = begin_date_time) %>%
  select(date, event_type, begin_lat, begin_lon, end_lat, end_lon) %>%
  mutate(date = dmy_hms(date)) %>%
  mutate(week = week(date), 
         year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11)

head(all_storm)


#Remove double events 
storm_events <- unique(all_storm[c("year", "week", "event_type")])
  
```

Add interactive feature with number of positive or negative mosquitos found
Can use to see the locations where more positive mosquitoes are found
```{r}

pal <- colorFactor(viridis(7), final_mosquito$result)

# find the total # mosquitoes collected each week
mosquito_data_tot_leaf <- mosquito_data %>%
  group_by(latitude, longitude) %>%
  summarise(total_no_mos = sum(number_mosquitos))


# find the sum of the # of positive mosquitoes collected each week
positive_mosquito_leaf <- mosquito_data %>%
  group_by(latitude, longitude) %>%
  filter(result == "positive") %>%
  summarise(pos_mos_no = sum(number_mosquitos))

# join the positive mosquitoes and total # of mosquitoes and calculate the proportion of positive mosquitoes collected each week 
final_mosquito_leaf <- mosquito_data_tot_leaf %>%
  full_join(positive_mosquito_leaf) %>%
  mutate_if(is.integer, funs(replace(., is.na(.), 0))) %>%
  mutate(prop_pos_mos = pos_mos_no / total_no_mos) %>%
  select(latitude, longitude, pos_mos_no, total_no_mos, prop_pos_mos)

# create popup info for 
popup_info <- paste0("<b>Proportion positive mosquitoes<b>", final_mosquito_leaf$prop_pos_mos)

pal <- colorNumeric(
  palette = viridis(7),
  domain = final_mosquito_leaf$prop_pos_mos
  
  
)

leaflet(data = final_mosquito_leaf) %>%
  addTiles() %>%
  addCircleMarkers(data = final_mosquito_leaf, radius = ~prop_pos_mos*10,
                   lng = ~longitude, lat = ~latitude, 
                   color = ~pal(prop_pos_mos),
                   group = "mosquito", popup = popup_info)  %>%
  addLegend(pal = pal, values = ~prop_pos_mos, opacity = 0.9) 


  
```



Read in soil data and clean up
```{r, st. charles soil data}
soil_2017 <- read.delim("https://www.isws.illinois.edu/warm/data/cdfs/stcday.txt") %>% 
  filter(year %in% c(2016, 2017)) %>%
  select(year, month, day,
         avg_soiltemp_4in_sod, avg_soiltemp_2in_bare) %>% 
  unite(date, month, day, year, sep = "-") %>% 
  mutate(date = mdy(date)) %>% 
  mutate(week = week(date)) %>% 
  mutate(year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11) %>%
  na.omit()

soil_2018 <- 
  read.delim("https://www.isws.illinois.edu/warm/data/cdfs/current/stcday18.txt") %>% 
  select(year, month, day,
         avg_soiltemp_4in_sod, avg_soiltemp_2in_bare) %>% 
  unite(date, month, day, year, sep = "-") %>% 
  mutate(date = mdy(date)) %>% 
  slice(-1) %>% 
  mutate(week = week(date)) %>% 
  mutate(year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11) %>%
  na.omit()

all_soil_temps <-
  rbind(soil_2017, soil_2018) %>% 
  mutate(avg_soiltemp_4in_sod = as.numeric(as.character(avg_soiltemp_4in_sod))) %>%
  mutate(avg_soiltemp_2in_bare = as.numeric(as.character(avg_soiltemp_2in_bare))) %>%
  group_by(year, week) %>% 
  summarise(avg_soil_t_4 = mean(avg_soiltemp_4in_sod, 
                                na.rm = TRUE),
            avg_soil_t_2 = mean(avg_soiltemp_2in_bare, 
                                na.rm = TRUE))

head(all_soil_temps)

tail(all_soil_temps)

```


Read in weather data and clean up
```{r weather}

weather_data <- 
  read_csv("../data/weather_data.csv") %>% 
  rename(station = "STATION",
         name = "NAME",
         date = "DATE") %>% 
  mutate(week = week(date)) %>% 
  mutate(year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11) %>% 
  group_by(year, week) %>% 
  mutate(TMAX_avg = mean(TMAX, na.rm = TRUE)) %>% 
  mutate(TMIN_avg = mean(TMIN, na.rm = TRUE)) %>% 
  mutate(avg_temp = (TMIN_avg + TMAX_avg)/2) %>% 
  mutate(max_wind = max(WDMV, na.rm = TRUE )) %>% 
  select(-TOBS, -date, -SN32, -SN52, -SX32, -SX52, -station, -name,
         -TMAX, -TMIN, -WDMV) %>% 
  arrange(year, week) %>%
  filter(row_number() == 1) %>% 
  ungroup()
  
head(weather_data)

precip_data <- read_csv("../data/precip.csv") %>% 
  select(PRCP, DATE) %>% 
  mutate(week = week(DATE)) %>% 
  mutate(year = year(DATE)) %>%
  filter(month(DATE) > 4 & month(DATE) < 11) %>% 
  select(year, week, PRCP) %>%
  group_by(year, week) %>% 
  summarise(precip_mean = mean(PRCP, na.rm = TRUE)) %>%
  arrange(year, week) %>% 
  ungroup()

head(precip_data)

```


Join all of the datasets together
We're not sure why we can't 
```{r}

all_data <- left_join(final_mosquito, storm_events, by = c("year", "week")) %>%
            left_join(all_soil_temps, by =  c("year", "week")) %>%
            left_join(weather_data, by =  c("year", "week")) %>% 
            left_join(precip_data, by =  c("year", "week"))

head(all_data)

all_data_wo_storm <- left_join(final_mosquito, all_soil_temps, by = c("year", "week")) %>%
            left_join(weather_data, by =  c("year", "week")) %>% 
            left_join(precip_data, by =  c("year", "week"))

```

Plot positive mosquito and precipitation

Compare the preciptation by week and positive mosquitos by week on top of each other to see similarities-- acutally try to add on top of graph
 
```{r}

pos_2016 <- full_join(positive_mosquito, all_data) %>%
  filter(year == 2016)


# 2D hexbin plots


ggplot(pos_2016, aes(x = week, y = precip_mean)) +
  geom_point() +
  geom_smooth() +
  labs(x = "Week of 2016", y = "Precipitation in inches") +
  ggtitle("Precipitation by Week in 2016")

new_mos<- mosquito_data %>%
  group_by(week, year, result) %>%
  summarise(no_mos = sum(number_mosquitos))

pos_plus_all <- full_join(new_mos, all_data) %>%
  filter(year == 2016)

ggplot(pos_plus_all, aes(x = week, y = no_mos, fill = result)) +
  geom_bar(stat = "identity") +
  labs(x = "Week of 2016", y = "Number of collected mosquitoes") +
  ggtitle("Positive West Nile Virus Mosquitoes 2016")

ggplot(pos_plus_all, aes(x = no_mos, y = precip_mean)) +
  geom_point() +
  geom_smooth() +
  labs(x = "number collected mosquitos", y = "average precipitation") +
  ggtitle("Not looking great on correlation")


```

# Prediction Models

Split the data into 2, one fore training the prediction models, and the other for testing 
```{r}
train_all_data <- all_data %>%
  filter(year %in% c(2016, 2017))

test_all_data <- all_data %>%
  filter(year == 2018)
```


## Linear Model

Build linear prediction model for proportion of positive mosquitos

```{r}

# input the variables we believe to be predictive
equation_test <- formula(prop_pos_mos ~ fp(week) +fp(avg_temp) + fp(precip_mean) + fp(avg_soil_t_4) + fp(avg_soil_t_2) )

# multivariate fractional polynomials will determine to what power each variable should be multiplied
mfp_testing <- mfp(equation_test, data = train_all_data, select = 0.05)

# perform linear model with the formula developed from the mfp_testing
linear_fit <- lm(mfp_testing$formula, train_all_data)

mfp_testing$formula

# summary of linear fit with the r^2 value
summary(linear_fit)

# test prediction model
predict.lm(linear_fit, data_frame(precip_mean = 0.078, avg_soil_t_4 = 72.1, avg_soil_t_2 = 74.7, week = 34, avg_temp = 75))

# get the mean average error fo the linear model
mae(model = linear_fit, data = test_all_data)
```

## Regression Tree MOdel

```{r}

# build regression tree model
tree_fit <- rpart(prop_pos_mos ~ precip_mean + avg_soil_t_4 + avg_soil_t_2 + week + avg_temp,
  	method="class", data = train_all_data)

printcp(tree_fit) # display the results 
summary(tree_fit) # detailed summary of splits
#importance(tree_fit)

# get the mean average error for our model
mae(model = tree_fit, data = test_all_data)


# plot decision tree 
prp(tree_fit, main="Classification Tree for Predicting Proportion of Positive Mosquitoes")	


```
## Random Forest Model

Plot variable importance 
```{r}

# build random forest prediction model
forest_fit <- randomForest(prop_pos_mos ~ precip_mean + avg_soil_t_4 + avg_soil_t_2 + week + avg_temp,
  	data = train_all_data, importance = TRUE)

# get the mean average error for our model
mae(model = forest_fit, data = test_all_data)

print(forest_fit) # view results 

varImpPlot(forest_fit,main="Important variables Random Forest")

impor_var <- as.data.frame(forest_fit$importance) %>%
  add_rownames("variables") 

ggplot(impor_var, aes(x = reorder(variables, -IncNodePurity), y = IncNodePurity, fill = variables)) +
  geom_bar(stat = "identity") +
  ylab("Node Purity")+
  xlab("Variables") +
  ggtitle("Importance of Random Forest Variables")

```

What does the mean average error look like if we did not split the data into training and testing data to begin
```{r}

# multivariate fractional polynomials will determine to what power each variable should be multiplied
mfp_testing_all <- mfp(equation_test, data = all_data, select = 0.05)

# perform linear model with the formula developed from the mfp_testing
linear_fit_all <- lm(mfp_testing_all$formula, all_data)

# get the mean average error fo the linear model
mae(model = linear_fit_all, data = all_data)

# build regression tree model
tree_fit_all <- rpart(prop_pos_mos ~ precip_mean + avg_soil_t_4 + avg_soil_t_2 + week + avg_temp,
  	method="class", data = all_data)

# get the mean average error for our model
mae(model = tree_fit_all, data = all_data)

# build random forest prediction model
forest_fit_all <- randomForest(prop_pos_mos ~ precip_mean + avg_soil_t_4 + avg_soil_t_2 + week + avg_temp,
  	data = all_data, importance = TRUE)

# get the mean average error for our model
mae(model = forest_fit_all, data = all_data)
```



Correlation matrix using correlogram 
Looks at different types of correlograms to visualize data

```{r fig.width =7, fig.height = 7}

# Remove columns with character values and malke pretty label names
data_wo_char <- all_data %>%
  select(-event_type, -year, -TMIN_avg, -TMAX_avg, -max_wind) %>%
  rename("# of WNV mosquitoes"= pos_mos_no,
         "total # of mosquitoes" = total_no_mos,
         "ratio of WNV mosquitoes" = prop_pos_mos,
         "average 4 inch soil temp" = avg_soil_t_4,
         "average 2 inch soil temp" = avg_soil_t_2,
         "average temp" = avg_temp,
         "average precipitation" = precip_mean)

correlation <- cor(data_wo_char)

corrplot(correlation, method = "number", "upper", 
         title = "Variable Correlation Plot",
         mar=c(0,0,2,0))

```


```{r}
library(corrr)

data_wo_char %>% 
    correlate() %>% 
  network_plot(min_cor = .2)



data_wo_char %>% 
  correlate() %>% 
  rearrange() %>% 
  shave() %>% 
  fashion()
```
