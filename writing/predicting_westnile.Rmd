---
title: "predicting_westnile"
author: "Camron Pearce, Amy Fox, Alyssa Melvin, Kayla Williams"
date: "November 7, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
library(readr)
library(dplyr)
library(lubridate)
library(stringr)
library(leaflet)
library(viridisLite)
library(tidyr)
library(rnoaa)
library(corrplot)

```

```{r}
mosquito_data_original <- read_csv("https://data.cityofchicago.org/api/views/jqe8-8r6s/rows.csv?accessType=DOWNLOAD") 

mosquito_data <- mosquito_data_original %>%
  filter(`SEASON YEAR` %in% c(2016, 2017, 2018)) %>%
  mutate(`TEST DATE` = mdy_hms(`TEST DATE`)) %>%
  rename_all(.funs = str_to_lower) %>%
  rename(year = `season year`, test_id = `test id`, test_date = `test date`,
         number_mosquitos = `number of mosquitoes`)

head(mosquito_data)

positive_mosquito <- mosquito_data %>%
  filter(result == "positive")



```

Read in and clean storm data
```{r storm data}
storms_2016 <- read_csv("../data/StormEvents_details-ftp_v1.0_d2016_c20180718.csv") 

storms_2017 <- read_csv("../data/StormEvents_details-ftp_v1.0_d2017_c20181017.csv")

storms_2018 <- read_csv("../data/StormEvents_details-ftp_v1.0_d2018_c20181017.csv")

all_storm <- rbind(storms_2016, storms_2017, storms_2018) %>%
  rename_all(.funs = str_to_lower) %>%
  filter(state == "ILLINOIS" & cz_name == "COOK") %>%
  mutate(date = begin_date_time) %>%
  select(date, event_type, begin_lat, begin_lon, end_lat, end_lon) %>%
  mutate(date = dmy_hms(date)) %>%
  mutate(week = week(date), 
         year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11)

head(all_storm)


#Remove double events 
storm_events <- unique(all_storm[c("year", "week", "event_type")])
  
```

Add interactive feature with number of positive or negative mosquitos found
```{r}

pal <- colorFactor(viridis(2), mosquito_data$result)

popup_info <- paste0("<b>Time<b>", mosquito_data$test_date,
                     "<b>Case<b>", mosquito_data$result)

leaflet() %>%
  addTiles() %>%
  addCircleMarkers(data = mosquito_data, radius = 2, lng = ~longitude, lat = ~latitude, 
                   color = pal(mosquito_data$result), opacity = 0.9, group = "mosquito", popup = popup_info) %>% 
  addCircleMarkers(data = mosquito_data, radius = 2, lng = ~longitude, lat = ~latitude, 
                   color = pal(positive_mosquito$result), opacity = 0.9, group = "positive mosquito") %>%
  addLegend(pal = pal, values = mosquito_data$result, opacity = 0.9) %>%
  addLayersControl(baseGroups = c("base map"),
                   overlayGroups = c("mosquito", "positive mosquito"))

#size of circle- total #
#proportion of positive  mosquitoes viridis color
# 
  
```



```{r, st. charles soil data}
soil_2017 <- read.delim("https://www.isws.illinois.edu/warm/data/cdfs/stcday.txt") %>% 
  filter(year %in% c(2016, 2017)) %>%
  select(year, month, day,
         avg_soiltemp_4in_sod, avg_soiltemp_2in_bare) %>% 
  unite(date, month, day, year, sep = "-") %>% 
  mutate(date = mdy(date)) %>% 
  mutate(week = week(date)) %>% 
  mutate(year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11) %>%
  na.omit()

soil_2018 <- 
  read.delim("https://www.isws.illinois.edu/warm/data/cdfs/current/stcday18.txt") %>% 
  select(year, month, day,
         avg_soiltemp_4in_sod, avg_soiltemp_2in_bare) %>% 
  unite(date, month, day, year, sep = "-") %>% 
  mutate(date = mdy(date)) %>% 
  slice(-1) %>% 
  mutate(week = week(date)) %>% 
  mutate(year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11) %>%
  na.omit()

all_soil_temps <-
  rbind(soil_2017, soil_2018) %>% 
  mutate(avg_soiltemp_4in_sod = as.numeric(as.character(avg_soiltemp_4in_sod))) %>%
  mutate(avg_soiltemp_2in_bare = as.numeric(as.character(avg_soiltemp_2in_bare))) %>%
  group_by(year, week) %>% 
  summarise(avg_soil_t_4 = mean(avg_soiltemp_4in_sod, na.rm = TRUE),
            avg_soil_t_2 = mean(avg_soiltemp_2in_bare, na.rm = TRUE))

head(all_soil_temps)


tail(all_soil_temps)

```



```{r weather}


weather_data <- read_csv("../data/weather_data.csv") %>% 
  rename(station = "STATION",
         name = "NAME",
         date = "DATE",
         wind_speed = "AWND",
         precip = "PRCP") %>% 
  mutate(week = week(date)) %>% 
  mutate(year = year(date)) %>%
  filter(month(date) > 4 & month(date) < 11)

colnames(weather_data)

#works for all?
weather_data <- weather_data %>% 
  group_by(year, week) %>% 
  summarise(precip_mean = mean(precip, na.rm = TRUE)) %>% 
  ungroup()
```


```{r}

all_data <- full_join(mosquito_data, storm_events)
all_data <- full_join(all_data, all_soil_temps)
all_data <- full_join(all_data, weather_data)


head(all_data)

```

Plot positive mosquito and precipitation

Compare the preciptation by week and positive mosquitos by week on top of each other to see similarities-- acutally try to add on top of graph
```{r}

head(positive_mosquito)

all_pos <- full_join(positive_mosquito, all_data) %>%
  filter(year == 2016)
          
head(all_pos)

library(ggplot2)

# 2D hexbin plots

ggplot(all_pos, aes(x = week, y = precip_mean)) +
  geom_point() +
  geom_smooth() +
  labs(x = "Week of 2016", y = "Precipitation in inches??")
  ggtitle("Precipitation by Week in 2016")

new_mos<- mosquito_data %>%
  group_by(week, year, result) %>%
  summarise(no_mos = sum(number_mosquitos))

pos_plus_all <- full_join(new_mos, all_data) %>%
  filter(year == 2016)

ggplot(pos_plus_all, aes(x = week, y = no_mos, fill = result)) +
  geom_bar(stat = "identity") +
  labs(x = "Week of 2016", y = "Number of collected mosquitoes") +
  ggtitle("Positive West Nile Virus Mosquitoes 2016")

ggplot(pos_plus_all, aes(x = no_mos, y = precip_mean)) +
  geom_point() +
  geom_smooth() +
  labs(x = "number collected mosquitos", y = "average precipitation") +
  ggtitle("Not looking great on correlation")


```

If soil temp and moisture are highly corelated- may not need both

Time as x axis as predictor, bar charts with toal length of bar= number of mosquitos, color = # or mosquitos tested positive

Could do with total # of posquitos or proportion

Geom smooth for weather events or seasonal patterns for time - won't see outlier, just average

regression tree- works better than linear when looking at many things strongly correlated

Correlation matrix using correlogram (in works until joined dataset available)

```{r}
#correlation <- cor()
#corrplot(x, method = "number")
```



